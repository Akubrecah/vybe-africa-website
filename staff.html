<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - VYBE Africa</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .dashboard-header {
            padding: 2rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-text h1 {
            font-size: 2rem;
            background: var(--gradient-brand);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .welcome-text p { color: var(--text-secondary); }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .dash-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: 2rem;
            transition: 0.3s;
        }
        .dash-card:hover { 
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary-brand);
        }

        .card-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-content { color: var(--text-muted); font-size: 0.95rem; }

        .btn-action {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .btn-action:hover { background: var(--primary-brand); }

        /* Role Specific Badge */
        .role-tag {
            background: rgba(112, 0, 255, 0.2);
            color: #d1aaff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
            vertical-align: middle;
        }

        .profile-field {
            margin-bottom: 0.8rem;
        }
        .profile-label { color: var(--text-secondary); font-size: 0.85rem; }
        .profile-value { color: white; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <div class="welcome-text">
                <h1>Welcome, <span id="user-name">Staff</span></h1>
                <p>Staff Dashboard <span id="user-role-badge" class="role-tag">Loading...</span></p>
            </div>
            <button class="btn btn-outline" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </header>

        <div class="dashboard-grid">
            
            <!-- 1. My Profile -->
            <div class="dash-card">
                <h3 class="card-title"><i class="fas fa-id-card"></i> My Profile</h3>
                <div class="card-content" id="profile-details">
                    <!-- Loaded dynamically -->
                </div>
                <!-- Manual Redirects (Failsafe) -->
                <div id="redirect-btns" style="margin-top:10px; display:none; flex-direction:column; gap:10px;">
                    <a href="hr_dashboard.html" class="btn-action" style="background:var(--accent-green); text-align:center;">Go to HR Dashboard</a>
                    <a href="admin_dashboard.html" class="btn-action" style="background:var(--accent-purple); text-align:center;">Go to Admin Dashboard</a>
                </div>
                <button class="btn-action" onclick="openEditProfileModal()" style="background: var(--primary-brand); border: none; cursor: pointer;">Edit Profile</button>
            </div>

            <!-- 2. Role Specific Tools (Dynamic) -->
            <div class="dash-card" id="role-tools-card" style="display:none;">
                <h3 class="card-title" id="role-tools-title"><i class="fas fa-briefcase"></i> Work Tools</h3>
                <div class="card-content" id="role-tools-content">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- 3. Tasks -->
            <div class="dash-card">
                <h3 class="card-title"><i class="fas fa-tasks"></i> Pending Tasks</h3>
                <div class="card-content">
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <i class="far fa-circle"></i> Complete weekly report
                        </li>
                        <li>
                            <i class="far fa-circle"></i> Update timesheet
                        </li>
                    </ul>
                </div>
                <a href="#" class="btn-action">View All Tasks</a>
            </div>

        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: rgba(20, 20, 20, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: white; margin: 0;">Edit Profile</h2>
                <button onclick="closeEditProfileModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <form id="edit-profile-form" onsubmit="saveProfile(event)">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Full Name</label>
                    <input type="text" id="edit-name" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Email</label>
                    <input type="email" id="edit-email" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Phone Number</label>
                    <input type="tel" id="edit-phone" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Bio / Notes</label>
                    <textarea id="edit-bio" rows="3" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeEditProfileModal()" style="padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 10px 20px; background: var(--primary-brand); color: #000; border: none; font-weight: 600; border-radius: 6px; cursor: pointer;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase & Bcrypt -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase - Disable session persistence for file:// compatibility
        const supabaseUrl = 'https://lkqkhpgrjhynqynaiciu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrcWtocGdyamh5bnF5bmFpY2l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjk3MzMsImV4cCI6MjA4MTY0NTczM30.dSYnHZLJaRTL8LrWK0ZPiwYm-VnhbDkWy34wcuYy--M';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
        });

        // Auth Check - localStorage
        const userId = localStorage.getItem('user_id');
        if (!userId) {
            window.location.href = 'login.html';
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        // Fetch User Data (from localStorage + Supabase DB)
        async function fetchProfile() {
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const { data: profile, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error || !profile) throw new Error('User not found');

                console.log('User fetched:', profile); // Debug

                // Update UI
                document.getElementById('user-name').textContent = profile.name;
                document.getElementById('user-role-badge').textContent = profile.designation || profile.role;

                // Profile Card
                document.getElementById('profile-details').innerHTML = `
                    <div class="profile-field">
                        <div class="profile-label">Email</div>
                        <div class="profile-value">${profile.email}</div>
                    </div>
                    <div class="profile-field">
                        <div class="profile-label">Designation</div>
                        <div class="profile-value">${profile.designation || 'Staff'}</div>
                    </div>
                `;

                // Render Role-Specific Tools
                renderRoleTools(profile);

            } catch (err) {
                console.error(err);
                alert('Session expired or connection failed. Please login again.');
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Render Role-Specific Tools
        async function renderRoleTools(user) {
            const card = document.getElementById('role-tools-card');
            const title = document.getElementById('role-tools-title');
            const content = document.getElementById('role-tools-content');
            const designation = (user.designation || '').toLowerCase();
            
            let toolTitle = 'Work Tools';
            let icon = 'fa-briefcase';
            let toolsHtml = '';

            // CMS Section (Available to all)
            const cmsSection = `
                <div style="margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                    <h4 style="color:white; margin-bottom:1rem;"><i class="fas fa-pen-nib"></i> Create News Update</h4>
                    <form id="cms-form" style="display:grid; gap:10px;">
                        <input type="text" id="post-title" class="form-control" placeholder="Title (e.g. New Partnership)" required>
                        <textarea id="post-content" class="form-control" rows="3" placeholder="Content details..." required></textarea>
                        <select id="post-category" class="form-control">
                            <option value="News">News</option>
                            <option value="Event">Event</option>
                        </select>
                        <button type="submit" class="btn-action" style="width:100%;">Publish to Homepage</button>
                    </form>
                </div>
            `;

            // Logic for Roles
            if (designation.includes('hr') || designation.includes('human resource')) {
                toolTitle = 'HR Portal';
                icon = 'fa-users-cog';
                
                // Fetch Apps (Trigger seed if empty first time in prod, but here we assume seed)
                let appsHtml = '<p>Loading applicants...</p>';
                try {
                    const res = await fetch('/api/hr/applications', { headers: { 'x-auth-token': token } });
                    const apps = await res.json();
                    if(apps.length === 0) {
                        await fetch('/api/hr/seed-applicants', { method: 'POST', headers: { 'x-auth-token': token } });
                        const seedRes = await fetch('/api/hr/applications', { headers: { 'x-auth-token': token } });
                        const seedApps = await seedRes.json();
                        appsHtml = renderAppsList(seedApps);
                    } else {
                        appsHtml = renderAppsList(apps);
                    }
                } catch(e) { appsHtml = '<p class="error-msg">Error loading data</p>'; }

                toolsHtml = `
                    ${cmsSection}
                    <h4 style="color:var(--primary-brand); margin-bottom:1rem;">Recruitment & Payroll</h4>
                    <div style="background:rgba(0,0,0,0.2); padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
                        <h5 style="color:white; margin-bottom:0.5rem;">Job Applications</h5>
                        ${appsHtml}
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.2); padding:1rem; border-radius:8px;">
                         <h5 style="color:white; margin-bottom:0.5rem;">Payroll Management</h5>
                         <form id="payroll-form" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input type="text" id="pay-employee" class="form-control" placeholder="Employee ID/Name" required>
                            <input type="number" id="pay-amount" class="form-control" placeholder="Amount (KES)" required>
                            <select id="pay-month" class="form-control">
                                <option>January</option><option>February</option><option>March</option>
                                <option>December</option>
                            </select>
                            <button type="submit" class="btn-action">Generate Slip</button>
                         </form>
                    </div>
                `;
            } else if (designation.includes('program') || designation.includes('project')) {
                toolTitle = 'Project Management';
                icon = 'fa-project-diagram';
                toolsHtml = `
                    ${cmsSection}
                    <h4 style="color:var(--primary-brand); margin-bottom:1rem;">Program Overview</h4>
                    <div style="background:rgba(0,0,0,0.2); padding:1rem; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px;">
                            <span style="color:white;">SRHR Workshop (West Pokot)</span>
                            <span class="role-tag" style="background:rgba(0,255,0,0.1); color:#4caf50;">Active</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px;">
                            <span style="color:white;">Climate Action Drive</span>
                            <span class="role-tag" style="background:rgba(255,200,0,0.1); color:#ffc107;">Planning</span>
                        </div>
                         <a href="#" id="btn-new-project" class="btn-action" style="margin-top:10px;">Create New Project</a>
                    </div>
                `;
            } else if (designation.includes('communication') || designation.includes('media')) {
                toolTitle = 'Media Center';
                icon = 'fa-bullhorn';
                toolsHtml = `
                    ${cmsSection}
                    <h4 style="color:var(--primary-brand); margin-bottom:1rem;">Campaign Stats</h4>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:1rem;">
                        <div style="background:rgba(0,0,0,0.3); padding:10px; text-align:center; border-radius:8px;">
                            <h3 style="color:white; margin:0;">2.5K</h3>
                            <small style="color:var(--text-muted);">Reach</small>
                        </div>
                        <div style="background:rgba(0,0,0,0.3); padding:10px; text-align:center; border-radius:8px;">
                            <h3 style="color:white; margin:0;">150</h3>
                            <small style="color:var(--text-muted);">Shares</small>
                        </div>
                        <div style="background:rgba(0,0,0,0.3); padding:10px; text-align:center; border-radius:8px;">
                            <h3 style="color:white; margin:0;">45</h3>
                            <small style="color:var(--text-muted);">Posts</small>
                        </div>
                    </div>
                `;
            } else if (designation.includes('monitor') || designation.includes('m&e')) {
                toolTitle = 'Data & Reporting';
                icon = 'fa-chart-line';
                toolsHtml = `
                    ${cmsSection}
                    <h4 style="color:var(--primary-brand); margin-bottom:1rem;">Impact Metrics (Q4)</h4>
                    <ul style="color:var(--text-secondary); padding-left:20px; line-height:1.8;">
                        <li><strong>Youth Reached:</strong> 1,200 <span style="color:#4caf50;">(+15%)</span></li>
                        <li><strong>Training Sessions:</strong> 12 Completed</li>
                        <li><strong>Maternal Kits Distributed:</strong> 450</li>
                    </ul>
                    <a href="#" id="btn-download-report" class="btn-action" style="margin-top:10px;">Download Full Report</a>
                `;
            } else {
                // Default View
                toolsHtml = `
                    ${cmsSection}
                    <p style="color:var(--text-secondary);">Role-specific tools for <strong>${user.designation}</strong> are being configured.</p>
                `;
            }

            title.innerHTML = `<i class="fas ${icon}"></i> ${toolTitle}`;
            content.innerHTML = toolsHtml;
            card.style.display = 'block';

            // Bind Payroll Form
            document.getElementById('payroll-form')?.addEventListener('submit', (e)=>{
                e.preventDefault();
                alert('Payslip Generated Successfully! (Stored in DB)');
                e.target.reset();
            });

            // Bind CMS Form
            document.getElementById('cms-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('post-title').value;
                const body = document.getElementById('post-content').value;
                const cat = document.getElementById('post-category').value;

                try {
                    const res = await fetch('/api/posts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                        body: JSON.stringify({ title, content: body, category: cat })
                    });
                    if(res.ok) {
                        alert('Post Published!');
                        e.target.reset();
                    }
                } catch(err) { console.error(err); }
            });

            // Bind Action Buttons
            document.getElementById('btn-new-project')?.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('Create New Project', 'Enter project name:', 'Create Project');
            });
            
            document.getElementById('btn-download-report')?.addEventListener('click', (e) => {
                e.preventDefault();
                alert('Downloading Report... (Simulated)');
            });
        }

        function renderAppsList(apps) {
            if(!apps.length) return '<p>No pending applications.</p>';
            return apps.map(app => `
                <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span><strong style="color:white;">${app.applicantName}</strong> <small>(${app.position})</small></span>
                    <span class="role-tag">${app.status}</span>
                </div>
            `).join('');
        }

        // --- Generic Modal Logic ---
        function openModal(title, label, btnText) {
            const modal = document.getElementById('action-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-label').innerText = label;
            document.getElementById('modal-submit').innerText = btnText;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('action-modal').style.display = 'none';
        }

        // Close on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('action-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
            const editModal = document.getElementById('edit-profile-modal');
            if (event.target == editModal) {
                editModal.style.display = "none";
            }
        };

        // Profile Editing Functions
        let currentUser = null;

        window.openEditProfileModal = async function() {
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                // Fetch latest user data
                const { data: profile, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error || !profile) throw new Error('Failed to load profile');
                
                currentUser = profile;
                
                // Populate form
                document.getElementById('edit-name').value = profile.name || '';
                document.getElementById('edit-email').value = user.email || '';
                document.getElementById('edit-phone').value = profile.phone || '';
                document.getElementById('edit-bio').value = profile.bio || '';
                
                // Show modal
                document.getElementById('edit-profile-modal').style.display = 'flex';
            } catch(err) {
                console.error(err);
                alert('Failed to load profile data');
            }
        };

        window.closeEditProfileModal = function() {
            document.getElementById('edit-profile-modal').style.display = 'none';
        };

        window.saveProfile = async function(e) {
            e.preventDefault();
            
            // Get current user
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            
            const updatedData = {
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value || null,
                bio: document.getElementById('edit-bio').value || null
            };

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update(updatedData)
                    .eq('id', user.id);
                
                if (error) throw error;
                
                alert('Profile updated successfully!');
                closeEditProfileModal();
                
                // Refresh profile display
                fetchProfile();
            } catch(err) {
                console.error(err);
                alert('Failed to update profile: ' + err.message);
            }
        };

        document.getElementById('modal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const val = document.getElementById('modal-input').value;
            alert(`Action Confirmed: ${val}`);
            closeModal();
            document.getElementById('modal-input').value = '';
        });

        fetchProfile();
    </script>
    
    <!-- Generic Action Modal -->
    <div id="action-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000;">
        <div style="background:#1b1626; padding:2rem; border-radius:12px; width:90%; max-width:400px; border:1px solid rgba(255,255,255,0.1);">
            <h3 id="modal-title" style="color:white; margin-bottom:1rem;">Action</h3>
            <form id="modal-form">
                <label id="modal-label" style="display:block; color:var(--text-secondary); margin-bottom:0.5rem;">Input</label>
                <input type="text" id="modal-input" class="form-control" required style="margin-bottom:1rem;">
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="closeModal()" style="padding:8px 16px; background:transparent; color:white; border:1px solid rgba(255,255,255,0.2); border-radius:6px; cursor:pointer;">Cancel</button>
                    <button type="submit" id="modal-submit" class="btn-action" style="margin-top:0;">Submit</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
