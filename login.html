<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Login - VYBE Africa</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #050505;
            background-image: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #050505 100%);
            font-family: 'Space Grotesk', sans-serif;
            padding: 1rem;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .login-logo i {
            font-size: 3rem;
            color: #facc15;
            margin-bottom: 1.5rem;
        }

        h1 { color: white; font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { color: #9ca3af; margin-bottom: 2rem; }

        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; color: #9ca3af; margin-bottom: 0.5rem; font-size: 0.9rem; }

        input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            transition: 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #facc15;
            background: rgba(0, 0, 0, 0.5);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #facc15 0%, #f59e0b 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            font-family: inherit;
        }

        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(250, 204, 21, 0.3); }
        .btn-login:disabled { opacity: 0.6; cursor: not-allowed; }

        .error-msg {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #f87171;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
            text-align: left;
        }

        .success-msg {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #34d399;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
        }

        .links { margin-top: 1.5rem; }
        .links a { color: #9ca3af; text-decoration: none; font-size: 0.9rem; display: block; margin: 0.5rem 0; }
        .links a:hover { color: #facc15; }

        .debug-info {
            margin-top: 1rem;
            font-size: 0.7rem;
            color: #6b7280;
            text-align: left;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="login-logo">
            <i class="fas fa-user-shield"></i>
        </div>
        
        <h1>Staff Login</h1>
        <p class="subtitle">VYBE Africa Staff Portal</p>

        <div class="error-msg" id="error-msg"></div>
        <div class="success-msg" id="success-msg"></div>

        <form id="login-form" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" required autofocus placeholder="Enter your email">
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required placeholder="Enter your password">
            </div>

            <button type="submit" class="btn-login" id="submit-btn">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
        </form>

        <div class="links">
            <a href="member_login.html"><i class="fas fa-users"></i> Member Login</a>
            <a href="homepage.html"><i class="fas fa-home"></i> Back to Home</a>
        </div>

        <div class="debug-info" id="debug-info"></div>
    </div>

    <!-- Supabase for database & bcrypt for password -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    
    <script>
        // Initialize Supabase (for database only)
        const supabaseUrl = 'https://mdjokagpejujfjfobdcs.supabase.co';
        const supabaseKey = 'sb_publishable_Y9Wv-aZdMFVv55-CYgj2AA_6l3Iz31G';
        
        // Disable session persistence and auto-refresh for file:// protocol compatibility
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: false,
                autoRefreshToken: false,
                detectSessionInUrl: false
            }
        });

        // Robust bcrypt loader
        const bcrypt = window.dcodeIO ? window.dcodeIO.bcrypt : window.bcrypt;

        function showError(msg) {
            document.getElementById('error-msg').textContent = msg;
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';
        }

        function showSuccess(msg) {
            document.getElementById('success-msg').innerHTML = msg;
            document.getElementById('success-msg').style.display = 'block';
            document.getElementById('error-msg').style.display = 'none';
        }

        function debug(msg) {
            console.log('[LOGIN]', msg);
            const el = document.getElementById('debug-info');
            el.style.display = 'block';
            el.innerHTML += msg + '<br>';
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            document.getElementById('error-msg').style.display = 'none';
            document.getElementById('success-msg').style.display = 'none';
            document.getElementById('debug-info').innerHTML = '';

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';

            try {
                if (!bcrypt) {
                    debug('CRITICAL: bcrypt library not loaded!');
                    // Fallback to naive check if bcrypt missing (only for emergency/testing if plain text used)
                    debug('Proceeding with fallback check...');
                }

                debug('Querying database for: ' + email);

                // Query users table
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email);

                if (error) {
                    debug('DB Error: ' + error.message);
                    showError('Database connection failed: ' + error.message);
                    return;
                }

                if (!users || users.length === 0) {
                    debug('No user found with that email');
                    showError('Invalid email or password');
                    return;
                }

                const user = users[0];
                debug('User found: ' + user.name + ' (' + user.role + ')');

                // Compare password
                let passwordMatch = false;
                
                if (bcrypt) {
                    debug('Verifying password with bcrypt...');
                    try {
                        passwordMatch = bcrypt.compareSync(password, user.password);
                    } catch (e) {
                        debug('Bcrypt verify error: ' + e.message);
                        // Try plain text match as fallback
                        if (password === user.password) passwordMatch = true;
                    }
                } else {
                    // Fallback plain text
                    if (password === user.password) passwordMatch = true;
                }

                if (!passwordMatch) {
                    debug('Password mismatch');
                    showError('Invalid email or password');
                    return;
                }

                debug('Password correct!');
                
                // Store session
                try {
                    localStorage.setItem('token', 'session_' + Date.now());
                    localStorage.setItem('user_id', user.id);
                    localStorage.setItem('email', user.email);
                    localStorage.setItem('name', user.name);
                    localStorage.setItem('role', user.role || 'staff');
                    localStorage.setItem('designation', user.designation || '');
                    debug('Session saved to localStorage');
                } catch (e) {
                    debug('Storage Error: ' + e.message);
                    alert('Warning: Could not save session (Cookies/Storage blocked?)');
                }

                // Redirect Logic
                const role = (user.role || '').toLowerCase().trim();
                const designation = (user.designation || '').toLowerCase().trim();
                let redirectUrl = 'staff.html';

                if (role === 'superadmin' || role === 'admin' || designation.includes('executive')) {
                    redirectUrl = 'admin_dashboard.html';
                } else if (role === 'hr' || designation.includes('hr')) {
                    redirectUrl = 'hr_dashboard.html';
                } else if (role === 'programs' || designation.includes('program')) {
                    redirectUrl = 'programs_dashboard.html';
                }

                debug('Redirecting to: ' + redirectUrl);
                
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Success!';
                
                // Show manual dashboard button which is reliable on file:// protocol
                const dashboardButtonHtml = `
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.2); border-radius: 8px; border: 1px solid #10b981;">
                        <p style="color: #34d399; margin-bottom: 0.5rem;">Login Verified!</p>
                        <a href="${redirectUrl}" class="btn-login" style="display: block; text-decoration: none; background: #10b981; color: white;">
                            <i class="fas fa-arrow-right"></i> Go to Dashboard
                        </a>
                    </div>
                `;
                
                showSuccess(dashboardButtonHtml);
                submitBtn.style.display = 'none'; // Hide login button

                // Try auto-redirect anyway
                window.location.href = redirectUrl;

            } catch (err) {
                debug('UNEXPECTED ERROR: ' + err.message);
                console.error(err);
                showError('Error: ' + err.message);
            } finally {
                if (!submitBtn.innerHTML.includes('Success')) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                }
            }
        }
    </script>
</body>
</html>
